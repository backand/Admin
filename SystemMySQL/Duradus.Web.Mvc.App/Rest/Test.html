<!DOCTYPE html>

<html>
<head runat="server">
    <meta name="viewport" content="width=device-width" />
    <title>Test</title>
    <link rel="shortcut icon" href="../Content/Images/back_favicon.ico"/>
    <link href="https://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" rel="stylesheet" />

    <link href="../Content/bootstrap.min.css" rel="stylesheet" />
    <!--<link href="../Content/jquery.jsonview.css" rel="stylesheet" />-->

    <link href="../Content/EasyUI/themes/default/easyui.css" rel="stylesheet" />
    <link href="../Content/EasyUI/themes/icon.css" rel="stylesheet" />

    
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    
    <script src="../Scripts/ngback/bootstrap.min.js"></script>
    
    <script src="../Scripts/jquery.easyui.min.js"></script>

    <script src="https://code.jquery.com/ui/1.11.0/jquery-ui.min.js"></script>

    <!--<script src="../Scripts/jquery.jsonview.js"></script>-->
    <script src="../Scripts/backand.js"></script>
    <script src="../Scripts/jquery.backand.js"></script>
    <script src="../Scripts/ngback/beautify.js"></script>
    <script src="../Scripts/backand.admin.js"></script>

    <script>
        function qs(key) {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars[key];
        }


        var data2 = null;
        

        var initJqBackand = function (url) {
            //var url = 'http://localhost:4109/WebApplication1';
            backand.options.url = url;

            var urlInput = $('input.url');
            //backand.security.authentication.token = 'Bearer LF6e7oMW84TWBuwvMP5ZnAIFXLfLxPlTnXqnSh5GSzD1YjbRU3frcom6i7xkKMrfnBdpXN2bYl4sBZ05gjDsp_9LAk-YnKHtJpC9ASUCd4cRS9AEEBIL9eDLUFCioNxJaUMuYHqsDxwm4lzntdvoOcVQsNWr6bIRYD6gA1w4OqZsLAsklhgCpYHRjF2xp5qU-5HO3VVzLl2QtXSGSSSWHRcKAh4AOpiYSEaV-Doynj5FypVCVdtNUDSeazqD0Q8Vpd41CX14QOcuMXH2pS5qSQ';
        };

        function login() {
            $('.login-container').show();
            
            //$('.login-container').dialog({
            //    modal: true, title: 'login', zIndex: 2147480000, autoOpen: true,
            //    width: 'auto', resizable: false,
            //    buttons: {
            //        login: function () {
            //            $(this).dialog("close");
            //            var username = $('.username').val();
            //            var password = $('.password').val();
            //            var appname = $('.appname').val();

            //            backand.security.authentication.getToken(username, password, appname);
            //        }
            //    },
            //    close: function (event, ui) {
            //        //$(this).remove();
            //    }
            //});
        }

        var getListParams = function () {
            var listParams = {};

            var filter = $('.filter').val();

            var filterData = filter ? JSON.parse(filter) : null;
            listParams.filter = JSON.stringify(filterData);

            var sort = $('.sort').val();

            var sortData = sort ? JSON.parse(sort) : null;
            listParams.sort = JSON.stringify(sortData);

            var deep = $('label.deep input').prop('checked');
            listParams.deep = deep;

            var withSelectOptions = $('label.with-select-options input').prop('checked');
            listParams.withSelectOptions = withSelectOptions;

            var withFilterOptions = $('label.with-filter-options input').prop('checked');
            listParams.withFilterOptions = withFilterOptions;

            var search = $('.search').val();
            listParams.search = search;

            try {
                var pageSize = parseInt($('.page-size').val());
                listParams.pageSize = pageSize;

            }
            catch (err) { }

            try {
                var pageNumber = parseInt($('.page-number').val());
                listParams.pageNumber = pageNumber;

            }
            catch (err) { }

            return listParams;
        }

        var success = null; 
        var error = null;

        var imageFieldsSelect;
        var viewSelect;
        $(document).ready(function () {
            $('.username').val(qs('username'));
            $('.password').val(qs('password'));
            $('.appname').val(qs('appname'));

            var versionSelect = $('.api-url-segment-version select');
            var repositorySelect = $('.api-url-segment-repository select');
            var configOrDataSelect = $('.api-url-segment-config select');
            viewSelect = $('.api-url-segment-view select');
            var dashboardSelect = $('.api-url-segment-dashboard select');
            var chartSelect = $('.api-url-segment-chart select');
            var contentSelect = $('.api-url-segment-content select');
            var idInput = $('.api-url-segment-id input');
            var duration = null;

            success = function (data, textStatus, xhr) {
                duration = (new Date()).getTime() - duration;

                var json = JSON.stringify(data);
                //$('.json-output').val(json);
                //$('.json-viewer2').jsonView(data);
                $('.json-viewer2').text(js_beautify(json));
                $('.duration').text(duration);
                $('.status').val(xhr.status);
                $('.location').val(xhr.getResponseHeader('location'));
            };
            error = function (xhr, textStatus, err) {
                $('.error-text').attr('src', xhr.responseText);
                $('.status').val(xhr.status);
                $('.location').val(xhr.getResponseHeader('location'));
                $('.json-viewer2').text(xhr.responseText);
                switch (xhr.status) {
                    case 401:
                        login();
                        break;

                    default:
                        break;
                }
            };

            var loadAppData = function () {
                var filterItem = new backand.filter.item("SystemView", backand.filter.operator.boolean.equals, false);
                var filter = [filterItem];

                var sortItem = new backand.sort.item("captionText", backand.sort.order.asc);

                var sort = [sortItem];

                backand.api.view.config.getList(null, null, 1000, filter, sort, null, function (data) {
                    var o = new Option("", "");
                    o.selected = true;
                    viewSelect.append(o);
                    $(data.data).each(function () {
                        var view = this;
                        o = new Option(view.captionText, view.name);
                        viewSelect.append(o);
                    });
                },
                function (xhr) { alert(JSON.stringify(xhr)); });

                backand.api.dashboard.config.getList(null, null, 1000, null, null, null, function (data) {
                    var o = new Option("", "");
                    o.selected = true;
                    dashboardSelect.append(o);
                    $(data.data).each(function () {
                        var dashboard = this;
                        o = new Option(dashboard.name, dashboard.id);
                        dashboardSelect.append(o);
                    });
                },
                function (xhr) { alert(JSON.stringify(xhr)); });

                backand.api.chart.config.getList(null, null, 1000, null, null, null, function (data) {
                    var o = new Option("", "");
                    o.selected = true;
                    chartSelect.append(o);
                    $(data.data).each(function () {
                        var chart = this;
                        o = new Option(chart.title, chart.id);
                        chartSelect.append(o);
                    });
                },
                function (xhr) { alert(JSON.stringify(xhr)); });

                backand.api.content.config.getList(null, null, 1000, null, null, null, function (data) {
                    var o = new Option("", "");
                    o.selected = true;
                    contentSelect.append(o);
                    $(data.data).each(function () {
                        var content = this;
                        o = new Option(content.title, content.id);
                        contentSelect.append(o);
                    });
                },
                function (xhr) { alert(JSON.stringify(xhr)); });
            }

            $('.login').click(function () {
                var username = $('.username').val();
                var password = $('.password').val();
                var appname = $('.appname').val();

                backand.security.authentication.login(username, password, appname,
                    function (data) {
                        if (data) {
                            $('.login-container').hide();
                            loadAppData();
                        }
                    },
                    function (xhr, textStatus, err) {
                        if (xhr && xhr.responseJSON && xhr.responseJSON.error_description) alert(xhr.responseJSON.error_description);
                    });
                

            });

            $('.logoButton').click(function () {
                backand.api.app.getConfig(function (data) {
                    var logoUrl = data.company.logo;
                    $('.logo').attr('src', logoUrl);
                });
            });

            $('button.version').click(function () {
                duration = (new Date()).getTime();
              
                clean();

                var useJqBackand = $('label.use-backand-js input').prop('checked');
                if (!useJqBackand) {
                    api(url, data, verb,
                        function (data, textStatus, xhr) {
                            var json = JSON.stringify(data);

                            $('.json-viewer2').text(js_beautify(json));

                            $('.status').val(xhr.status);
                            $('.location').val(xhr.getResponseHeader('location'));
                        },
                        function (xhr, textStatus, err) {
                            $('.error-text').attr('src', xhr.responseText);
                            $('.status').val(xhr.status);
                            $('.location').val(xhr.getResponseHeader('location'));
                        }
                    )
                }
                else {
                    backand.system.version.getInfo(success, error);
                }
            });


            var updateUrl = function () {
                var urlInput = $('input.url');
                var version = versionSelect.val();
                var repository = $('.api-url-segment-repository select').val();
                var configOrData = $('.api-url-segment-config select').val();
                var pageType = $('.api-url-segment-page-type:visible select').val();
                var id = idInput.val();
                if (repository != "view")
                    id = null;

                var url = backand.options.url;//[location.protocol, '//', location.host, location.pathname].join('').replace('/Rest/Test', '');
                urlInput.val(url + '/' + version + '/' + repository + '/' + configOrData + '/' + (pageType ? pageType : '') + (id ? '/' + id : '')); //+ '?id=' + userGuid);
            };


            var clean = function () {
                //$('.json-output').val('');
                $('.status').val('');
                $('.location').val('');
                $('.error').val('');
                $('.error-text').attr('src', '');
                $('.json-viewer2').text('');

                //$('.json-viewer2').jsonView('');

            };

            $('button.clean').click(function () {
                clean();
            });

            $.ajax({
                url: 'config.json',
                dataType: 'json',
                success: function (config) {
                    initJqBackand(config.apiurl);
                    updateUrl();
                    $('head').append("<script src='" + config.apiurl + "/api/banner'><\/script>");
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    //alert('error - ' + textStatus);
                    console.log('error', textStatus, errorThrown);
                }
            });

            
            $('label.use-backand-js input').prop('checked', true);

            $('button.submit').click(function () {
                duration = (new Date()).getTime();
                var url = $('.url').val();
                var verb = $('.verb').val();
                var json = $('.json-input').val();
                var jsonData = json ? JSON.parse(json) : null;
                var data = {};

                if (verb == backand.options.verbs.get) {
                    //var filter = $('.filter').val();

                    //var filterData = filter ? JSON.parse(filter) : null;
                    //data.filter = JSON.stringify(filterData);

                    //var sort = $('.sort').val();

                    //var sortData = sort ? JSON.parse(sort) : null;
                    //data.sort = JSON.stringify(sortData);

                    //var deep = $('label.deep input').prop('checked');
                    //data.deep = deep;

                    //var withSelectOptions = $('label.with-select-options input').prop('checked');
                    //data.withSelectOptions = withSelectOptions;

                    //try{
                    //    var pageSize = parseInt($('.page-size').val());
                    //    data.pageSize = pageSize;

                    //}
                    //catch (err) { }

                    //try {
                    //    var pageNumber = parseInt($('.page-number').val());
                    //    data.pageNumber = pageNumber;

                    //}
                    //catch (err) { }
                    data = getListParams();
                }
                else if (verb == "PUT" || verb == "POST") {
                    var json = $('.json-input').val();

                    var itemData = json ? JSON.parse(json) : null;
                    data = JSON.stringify(itemData);
                    
                }

                clean();
                
                

                var useJqBackand = $('label.use-backand-js input').prop('checked');
                if (!useJqBackand) {
                    api(url, data, verb,
                        function (data, textStatus, xhr) {
                            var json = JSON.stringify(data);
                            //$('.json-output').val(json);
                            //$('.json-viewer2').jsonView(data);
                            $('.json-viewer2').text(js_beautify(json));

                            $('.status').val(xhr.status);
                            $('.location').val(xhr.getResponseHeader('location'));
                        },
                        function (xhr, textStatus, err) {
                            $('.error-text').attr('src', xhr.responseText);
                            $('.status').val(xhr.status);
                            $('.location').val(xhr.getResponseHeader('location'));
                        }
                    )
                }
                else {
                    var repository = $('.api-url-segment-repository select').val();
                    var configOrData = $('.api-url-segment-config select').val();
                    

                    if (repository == 'app' && configOrData == 'config') {
                        backand.api.app.getConfig(success, error);
                    }
                    else if (repository == 'view') {
                            var viewName = $('.api-url-segment-view select').val();

                            if (configOrData == 'config') {
                                if (viewName) {
                                    backand.api.view.config.getItem(viewName, success, error);
                                }
                                else {
                                    var filter = $('.filter').val();

                                    var filterData = filter ? JSON.parse(filter) : null;
                                    var sort = $('.sort').val();

                                    var sortData = sort ? JSON.parse(sort) : null;

                                    var search = $('.search').val();

                                    backand.api.view.config.getList(data.withSelectOptions, data.withFilterOptions, data.pageNumber, data.pageSize, filterData, sortData, search, success, error);
                                }
                            }
                            else if (configOrData == 'data') {
                            var id = $('.api-url-segment-id input').val();
                            if (id) {
                                if (verb == backand.options.verbs.get) {
                                    backand.api.view.data.getItem(viewName, id, data.deep, success, error);
                                }
                                else if (verb == backand.options.verbs.put) {
                                    backand.api.view.data.updateItem(viewName, id, data, success, error);
                                }
                                else if (verb == backand.options.verbs.delete) {
                                    backand.api.view.data.deleteItem(viewName, id, success, error);
                                }
                            }
                            else {
                                if (verb == backand.options.verbs.post) {
                                    backand.api.view.data.createItem(viewName, data, success, error);
                                }
                                else {
                                    var filter = $('.filter').val();

                                    var filterData = filter ? JSON.parse(filter) : null;
                                    var sort = $('.sort').val();

                                    var sortData = sort ? JSON.parse(sort) : null;

                                    var search = $('.search').val();


                                    backand.api.view.data.getList(viewName, data.withSelectOptions, data.withFilterOptions, data.pageNumber, data.pageSize, filterData, sortData, search, success, error);
                                }
                            }
                        }
                        
                    }
                    else if (repository == 'dashboard') {
                        var id = $('.api-url-segment-dashboard select').val();

                        if (configOrData == 'config') {
                            backand.api.dashboard.config.getItem(id, success, error);
                        }
                        else if (configOrData == 'data') {
                            backand.api.dashboard.data.getItem(id, success, error);
                        }
                    }
                    else if (repository == 'chart') {
                        var id = $('.api-url-segment-chart select').val();

                        if (configOrData == 'config') {
                            backand.api.chart.config.getItem(id, success, error);
                        }
                        else if (configOrData == 'data') {
                            backand.api.chart.data.getItem(id, success, error);
                        }
                    }
                    else if (repository == 'content') {
                        var id = $('.api-url-segment-content select').val();

                        if (configOrData == 'config') {
                            backand.api.content.config.getItem(id, success, error);
                        }
                        
                    }
                }


                var jsonViewer = $('.json-viewer').click(function () {
                    var url = "http://jsonviewer.stack.hu"; ///#http://rellymssql002.backand.loc:51065/app/config?id=d87edf91-a559-48c1-afc7-d1bb62ced6ae";
                    var win = window.open(url, '_blank');
                    //win.focus();
                });

                
                
            });

            
            repositorySelect.change(function () {
                var val = $(this).val();
                switch (val) {
                    case 'app':
                        $('.api-url-segment-page-type').css('display', 'none');
                        $('.api-url-segment-id').css('display', 'none');
                        updateUrl();
                        break;

                    case 'view':
                        $('.api-url-segment-page-type').css('display', 'none');
                        $('.api-url-segment-view').css('display', 'inline-block');
                        var configOrData = $('.api-url-segment-config select').val();
                        if (configOrData == 'data')
                            $('.api-url-segment-id').css('display', 'inline-block');
                        updateUrl();
                        var view = viewSelect.val();
                        if (view)
                            viewChanged(view);

                        break;
                    case 'dashboard':
                        $('.api-url-segment-page-type').css('display', 'none');
                        $('.api-url-segment-dashboard').css('display', 'inline-block');
                        $('.api-url-segment-id').css('display', 'none');
                        updateUrl();
                       
                        break;
                    case 'chart':
                        $('.api-url-segment-page-type').css('display', 'none');
                        $('.api-url-segment-chart').css('display', 'inline-block');
                        $('.api-url-segment-id').css('display', 'none');
                        updateUrl();

                        break;
                    case 'content':
                        $('.api-url-segment-page-type').css('display', 'none');
                        $('.api-url-segment-content').css('display', 'inline-block');
                        $('.api-url-segment-id').css('display', 'none');
                        updateUrl();

                        break;
                    default:
                        break;
                }
            });

            configOrDataSelect.change(function () {
                var val = $(this).val();
                switch (val) {
                    case 'config':
                        $('.api-url-segment-id').css('display', 'none');
                        updateUrl();
                        break;

                    case 'data':
                        var repository = repositorySelect.val();
                        if (repository == 'view')
                            $('.api-url-segment-id').css('display', 'inline-block');
                        updateUrl();
                        break;
                    default:
                        break;
                }
            });

            viewSelect.change(function () {
                var view = $(this).val();
                viewChanged(view);
            });

            dashboardSelect.change(function () {
                updateUrl();

            });

            chartSelect.change(function () {
                updateUrl();

            });

            var viewChanged = function (view) {
                cleanAndLoadFields($('#filterBuilder'), view);
                cleanAndLoadFields($('#sortBuilder'), view);

            }

            var cleanAndLoadFields = function (grid, view) {
                grid.datagrid('loadData', { "total": 0, "rows": [] });
                var opts = grid.datagrid('getColumnOption', 'fieldName');
                opts.editor = {
                    type: 'combobox',
                    options: {
                        valueField: 'fieldName',
                        textField: 'fieldName',
                        data: getFields(view)
                        //onChange: function (newValue, oldValue) {
                        //    if (newValue) {
                        //        var col = $('#filterBuilder').datagrid('getColumnOption', 'operator');
                        //        col.editor = {
                        //            type: 'combobox',
                        //            options: {
                        //                valueField: 'operator',
                        //                textField: 'operator',
                        //                data: getOperatorJson(newValue)
                        //            }
                        //        }
                        //        $(col.editor).combobox('setValues', getOperatorJson(newValue));
                        //    }
                        //}
                    }
                }
            }

            idInput.change(function () {
                var val = $(this).val();
                updateUrl();

            });



            /// load sub-grid fields
            var configView = null;

            var subGridFieldsSelect = $('.sub-grid-fields')
            var subGridFieldsButton = $('.load-sub-grid-fields');
            subGridFieldsButton.click(function () {
                var view = viewSelect.val();
                if (!view) {
                    alert("please select a view");
                    viewSelect.focus();
                    return;
                }

                var id = idInput.val();
                if (!id) {
                    alert("please enter an id");
                    idInput.focus();
                    return;
                }

                backand.api.view.config.getItem(view, function (data) {
                    subGridFieldsSelect.empty();
                    var o = new Option("", "");
                    o.selected = true;
                    subGridFieldsSelect.append(o);
                    configView = data;
                    $(configView.fields).each(function () {
                        var field = this;
                        var isSubGridField = field.displayFormat == "Grid";
                        if (isSubGridField) {
                            o = new Option(field.displayName, field.name);
                            subGridFieldsSelect.append(o);
                        }
                    });
                },
                function (xhr) { alert(JSON.stringify(xhr)); });

            });

            $('.load-sub-grid-data').click(function () {
                var view = viewSelect.val();
                if (!view) {
                    alert("please select a view");
                    viewSelect.focus();
                    return;
                }

                var id = idInput.val();
                if (!id) {
                    alert("please enter an id");
                    idInput.focus();
                    return;
                }

                var fieldName = subGridFieldsSelect.val();
                if (!fieldName) {
                    alert("please select a sub-grid field");
                    subGridFieldsSelect.focus();
                    return;
                }

                if (!configView) {
                    alert("please load sub-grid fields");
                    subGridFieldsButton.focus();
                    return;
                }

                var field = backand.api.view.config.getFieldByName(configView, fieldName);

                // *** the actual subgrid example starts here
                var relatedViewName = field.relatedViewName;
                var relatedParentFieldName = field.relatedParentFieldName;
                var filterItem = new backand.filter.item(relatedParentFieldName, backand.filter.operator.relation.in, id);
                var filter = [filterItem];

                backand.api.view.data.getList(relatedViewName, null, null, null, filter, null, null, success, error);
                // *** the actual subgrid example ends here

            });
           
            var autoCompleteFieldsSelect = $('.auto-complete-fields')
            var autoCompleteFieldsButton = $('.load-auto-complete-fields');
            autoCompleteFieldsButton.click(function () {
                var view = viewSelect.val();
                if (!view) {
                    alert("please select a view");
                    viewSelect.focus();
                    return;
                }

                backand.api.view.config.getItem(view, function (data) {
                    autoCompleteFieldsSelect.empty();
                    var o = new Option("", "");
                    o.selected = true;
                    autoCompleteFieldsSelect.append(o);
                    configView = data;
                    $(configView.fields).each(function () {
                        var field = this;
                        var isAutoCompleteField = field.displayFormat == "AutoCompleteStratWith" || field.displayFormat == "AutoCompleteMatchAny";
                        if (isAutoCompleteField) {
                            o = new Option(field.displayName, field.name);
                            autoCompleteFieldsSelect.append(o);
                        }
                    });
                },
                function (xhr) { alert(JSON.stringify(xhr)); });

            });
            var autoCompleteInput = $('.auto-complete');
            
            autoCompleteFieldsSelect.change(function () {
                var viewName = viewSelect.val();
                var fieldName = autoCompleteFieldsSelect.val();

                autoCompleteInput.autocomplete({
                    source: function (request, response) {
                        backand.api.view.data.autoComplete(viewName, fieldName, { term: request.term, limit: 20 }, function (json) {
                            // call autocomplete callback method with results  
                            response($.map(json, function (option, x) {
                                return {
                                    label: option.label,
                                    value: option.value
                                }
                            }));
                        },
                        error);
                        //$.ajax({
                        //    url: backand.api.view.data.autoCompleteUrl(viewName, fieldName),
                        //    type: 'GET',
                        //    cache: false,
                        //    data: request,
                        //    dataType: 'json',
                        //    success: function (json) {
                        //        // call autocomplete callback method with results  
                        //        response($.map(json, function (name, val) {
                        //            return {
                        //                label: name,
                        //                value: val
                        //            }
                        //        }));
                        //    },
                        //    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        //        //alert('error - ' + textStatus);
                        //        console.log('error', textStatus, errorThrown);
                        //    }
                        //});
                    },
                    minLength: 2,
                    select: function (event, ui) {
                        alert('you have selected ' + ui.item.label + ' ID: ' + ui.item.value);
                        $('.auto-complete').val(ui.item.label);
                        return false;
                    }
                })
            });

            $('.unlock-user').click(function () {
                var username = $('.unlock-user-username').val();
                backand.security.unlock(username, success, error);
            });

            //$('#dg').datagrid('loadData', dataGridData);
            ////var opts = $('#dg').datagrid('getColumnOption', 'productid');
            ////opts.editor = {
            ////    type: 'combobox',
            ////    options: productjson
            ////}
        

            //$('#filterBuilder').datagrid({
            //    onClickCell: function (rowIndex, field, value) {
            //        var operatorjson = getOperatorJson(rowIndex);
            //        var col = $(this).datagrid('getColumnOption', 'operator');
            //        col.editor = {
            //            type: 'combobox',
            //            options: {
            //                valueField: 'operator',
            //                textField: 'operator',
            //                data: operatorjson
            //            }
            //        }
                    
            //    }
            //});

            imageFieldsSelect = $('.image-fields')
            var imageFieldsButton = $('.load-image-fields');
            imageFieldsButton.click(function () {
                var view = viewSelect.val();
                if (!view) {
                    alert("please select a view");
                    viewSelect.focus();
                    return;
                }

                backand.api.view.config.getItem(view, function (data) {
                    imageFieldsSelect.empty();
                    var o = new Option("", "");
                    o.selected = true;
                    imageFieldsSelect.append(o);
                    configView = data;
                    $(configView.fields).each(function () {
                        var field = this;
                        var isImageField = field.type == "Image";
                        if (isImageField) {
                            o = new Option(field.displayName, field.name);
                            imageFieldsSelect.append(o);
                        }
                    });
                },
                function (xhr) { alert(JSON.stringify(xhr)); });

            });
        });

        function api(url, data, verb, successCallback, erroCallback) {
            $.ajax({
                url: url,
                //contentType: 'application/json; charset=utf-8',
                async: false,
                type: verb,
                data: data ,
                dataType: 'jsonp',
                cache: false,
                error: function (xhr, textStatus, err) { erroCallback(xhr, textStatus, err); },
                success: function (data, textStatus, xhr) { successCallback(data, textStatus, xhr); }
            });
        }

        //function getOperatorJson(fieldName) {
        //    var operators = [];
        //    $(data2.fields).each(function () {
        //        if (this.internalName == fieldName) {
        //            switch (getFilterType(this)) {
        //                case 'numericOrDate':
        //                    operators = numericOrDateOperators;
        //                    break;
        //                case 'text':
        //                    operators = textOperators;
        //                    break;
        //                case 'relation':
        //                    operators = relationOperators;
        //                    break;

        //                default:
        //                    break;
        //            }
        //        }
        //    });

        //    return operators;
        //}

        function getFilterType(field) {
            if (field.type == "Numeric" || field.type == "Date")
                return 'numericOrDate';
            else if (field.type == "SingleSelect" || field.type == "MultiSelect")
                return 'relation';
            else
                return 'text';
        }

        function getFields(view) {
            var data3 = [];
            api('/1/view/config/' + view, null, "GET", function (data) {
                data2 = data;
            });

            $(data2.fields).each(function () {
                data3.push({ fieldName: this.name });
            });

            return data3;
        }

        </script>

    <script type="text/javascript">
        var editIndex = undefined;
        function endEditing() {
            if (editIndex == undefined) { return true }
            if ($('#filterBuilder').datagrid('validateRow', editIndex)) {
                var ed = $('#filterBuilder').datagrid('getEditor', { index: editIndex, field: 'fieldName' });
                if (!ed) return true;
                var fieldName = $(ed.target).combobox('getText');
                $('#filterBuilder').datagrid('getRows')[editIndex]['fieldName'] = fieldName;
                $('#filterBuilder').datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }
        function onClickRow(index) {
            if (editIndex != index) {
                if (endEditing()) {
                    $('#filterBuilder').datagrid('selectRow', index)
							.datagrid('beginEdit', index);
                    editIndex = index;
                } else {
                    $('#filterBuilder').datagrid('selectRow', editIndex);
                }
            }
        }
        function append() {
            if (endEditing()) {
                $('#filterBuilder').datagrid('appendRow', {  });
                editIndex = $('#filterBuilder').datagrid('getRows').length - 1;
                $('#filterBuilder').datagrid('selectRow', editIndex)
						.datagrid('beginEdit', editIndex);
            }
        }
        function removeit() {
            if (editIndex == undefined) { return }
            $('#filterBuilder').datagrid('cancelEdit', editIndex)
					.datagrid('deleteRow', editIndex);
            editIndex = undefined;
        }
        function accept() {
            if (endEditing()) {
                $('#filterBuilder').datagrid('acceptChanges');
                var myData = $('#filterBuilder').datagrid('getData');
                $('.filter').val(JSON.stringify(myData.rows));
            }
        }
        function reject() {
            $('#filterBuilder').datagrid('rejectChanges');
            editIndex = undefined;
        }
        function getChanges() {
            var rows = $('#filterBuilder').datagrid('getChanges');
            alert(rows.length + ' rows are changed!');
        }
	</script>

    <script type="text/javascript">
        var editSortIndex = undefined;
        function endSortEditing() {
            if (editSortIndex == undefined) { return true }
            if ($('#sortBuilder').datagrid('validateRow', editSortIndex)) {
                var ed = $('#sortBuilder').datagrid('getEditor', { index: editSortIndex, field: 'fieldName' });
                if (!ed) return true;
                var fieldName = $(ed.target).combobox('getText');
                $('#sortBuilder').datagrid('getRows')[editSortIndex]['fieldName'] = fieldName;
                $('#sortBuilder').datagrid('endEdit', editSortIndex);
                editSortIndex = undefined;
                return true;
            } else {
                return false;
            }
        }
        function onClickRow(index) {
            if (editSortIndex != index) {
                if (endSortEditing()) {
                    $('#sortBuilder').datagrid('selectRow', index)
							.datagrid('beginEdit', index);
                    editSortIndex = index;
                } else {
                    $('#sortBuilder').datagrid('selectRow', editSortIndex);
                }
            }
        }
        function appendSort() {
            if (endSortEditing()) {
                $('#sortBuilder').datagrid('appendRow', {});
                editSortIndex = $('#sortBuilder').datagrid('getRows').length - 1;
                $('#sortBuilder').datagrid('selectRow', editSortIndex)
						.datagrid('beginEdit', editSortIndex);
            }
        }
        function removeitSort() {
            if (editSortIndex == undefined) { return }
            $('#sortBuilder').datagrid('cancelEdit', editSortIndex)
					.datagrid('deleteRow', editSortIndex);
            editSortIndex = undefined;
        }
        function acceptSort() {
            if (endSortEditing()) {
                $('#sortBuilder').datagrid('acceptChanges');
                var myData = $('#sortBuilder').datagrid('getData');
                $('.sort').val(JSON.stringify(myData.rows));
            }
        }
        function rejectSort() {
            $('#sortBuilder').datagrid('rejectChanges');
            editSortIndex = undefined;
        }
        function getChangesSort() {
            var rows = $('#sortBuilder').datagrid('getChanges');
            alert(rows.length + ' rows are changed!');
        }
	</script>

    <style>
        div.api {padding:10px 10px 10px 10px;}

        .api-input {
            display:inline-block;
            float:left;
            width:600px;
        }
        .api-output {
            margin-left:620px;
        }
       .api fieldset  { display: table; }
        .api p     { display: table-row;  }
        .api label { display: table-cell; padding-top: 10px;}
        .api input { display: table-cell; width:40%;height:20px;}
        .api input[type=checkbox] { width:inherit;}
        .api select { display: table-cell; width:40%;height:20px;width:auto;}
        .api textarea { display: table-cell; width:80%;}

         fieldset   button.submit {
                margin-top:40px;
            }

       fieldset  .upper-tb button.submit {
                margin-top:0;
            }
        .api  iframe {
            width:80%;
            height:auto;
        }
        .api-url{padding: 0; }
        .api-url-segment {
            display: inline-block;
        }
        .api div.api-url-segment{
            padding: 0;
            padding-left: 5px;
        }
        .url{width:80%;}
        .api-url-segment-page-type {display:none;}
        .api-url-segment-id {display:none;}
        label.check-label{display:block;}
        label input{width:initial;margin: 0;
    vertical-align: bottom;
    position: relative;
    top: 1.999px;}

        .api-url fieldset {
            border: 1px solid #e5e5e5;
            padding: 5px;
        }
            .api-url fieldset legend {
                border:initial;
                margin: 0;
                padding: 0;
                width: inherit;
            }

            .json-viewer2{display:inherit; height:400px;}
        .login-container {
        }
        input.url{width:100%;}
    </style>
</head>
<body>
    <!--
    <style>#backand-banner .container {width: 100%;}#backand-banner .navbar-nav > li > a {padding-top:0;padding-bottom:0;color: #4c4c4c;}#backand-banner .navbar-brand{padding-top:0;}#backand-banner .navbar-nav > li > a {padding-top:5px !important; padding-bottom:5px !important;}#backand-banner.navbar {min-height:20px !important;background: #f3b858;border-bottom: 1px solid #1ba085;}#backand-banner .navbar-brand {padding-top: 5px;padding-bottom: 0;color: #4c4c4c;}</style>
    <nav id="backand-banner" class="navbar navbar-default" role="navigation"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="https://www.backand.com/">Back&</a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav"><li><a href="[adminUrl]/Admin/Pages?menuId=">Pages</a></li></ul><ul class="nav navbar-nav navbar-right"><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">aaaa@aaaa.com<b class="caret"></b></a><ul class="dropdown-menu"><li><a href="[adminUrl]/Account/ChangePassword">Change Password</a></li><li><a href="https://www.backand.com/apps">My Consoles</a></li><li><a href="https://www.backand.com/support">Support</a></li></ul></li></ul><ul class="nav navbar-nav navbar-right"><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Admin <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="[adminUrl]/Admin/Index/Database">Default Settings</a></li><li><a href="[adminUrl]/Admin/Index/View">Tables &amp; Views</a></li><li><a href="[adminUrl]/Admin/Index/Workspace">Workspaces</a></li><li><a href="[adminUrl]/Home/IndexPage/v_durados_User">Users</a></li><li><a href="[adminUrl]/Admin/Index/Rule">Business Rules</a></li><li><a href="[adminUrl]/Home/Index/Durados_Log">Trace</a></li></ul></li></ul></div></div></nav>
        -->
    <div class="api">
        <div class="api-input">
            <fieldset>
                <legend>Input</legend>
                <div class="upper-tb">
                <button class="clean">clean</button>
                <button class="submit">submit</button>
                <button class="version">Version</button>
                </div>

                <div class="api-url api-url-segments">
                    <fieldset>
                        <legend>namespaces:</legend>
                 
                    <label class="check-label use-backand-js"><input type="checkbox"/>use backand.js</label>
                    <div class="api api-url-segment api-url-segment-version">
                        <label>version:</label>
                        <select>
                            <option value="1">1</option>
                        </select>
                        /
                    </div>
                    <div class="api api-url-segment api-url-segment-repository">
                    <label>content part:</label>
                    <select>
                        <option value="app">app</option>
                        <option value="view">view</option>
                        <option value="dashboard">dashboard</option>
                        <option value="chart">chart</option>
                        <option value="content">content</option>
                    </select>
                    /
                    </div>
                    <div class="api api-url-segment api-url-segment-config">
                    <label>config/data:</label>
                    <select>
                        <option value="config">config</option>
                        <option value="data">data</option>
                    </select>
                    /
                    </div>
                    <div class="api api-url-segment api-url-segment-view api-url-segment-page-type">
                    <label>view:</label>
                    <select>
                        
                    </select>
                    /
                    </div>
                     <div class="api api-url-segment api-url-segment-dashboard api-url-segment-page-type">
                    <label>id:</label>
                    <select>
                        
                    </select>
                    /
                    </div>
                    <div class="api api-url-segment api-url-segment-chart api-url-segment-page-type">
                    <label>id:</label>
                    <select>
                        
                    </select>
                    /
                    </div>
                    <div class="api api-url-segment api-url-segment-content api-url-segment-page-type">
                        <label>id:</label>
                        <select></select>
                        /
                    </div>
                    <div class="api api-url-segment api-url-segment-id">
                    <label>id:</label>
                    <input type="text"/>
                    
                    </div>
                        </fieldset>
                
                </div>

                <div class="api api-url api-url-query">
                <fieldset>
                    <legend>query:</legend>
                
                    <label class="check-label deep"><input type="checkbox"/>deep</label>
                    <label class="check-label with-select-options"><input type="checkbox"/>with select options</label>
                    <label class="check-label with-filter-options"><input type="checkbox" />with filter options</label>
                    <label>page number:</label>
                    <input type="number" class="page-number"/>
                    <label>page size:</label>
                    <input type="number" class="page-size"/>
                    <label>sort:</label>
                    <div style="display:inherit;float:inherit;">

                        <table id="sortBuilder" class="easyui-datagrid" title="Create Sort Parameters" style="width:400px;height:auto"
			                    data-options="
				                    iconCls: 'icon-edit',
				                    singleSelect: true,
				                    toolbar: '#tbSort',
				                    method: 'get',
				                    onClickRow: onClickRow
			                    ">
		                    <thead>
			                    <tr>
				                    <th data-options="field:'fieldName',width:100,
						                    formatter:function(value,row){
							                    return row.fieldName;
						                    },
						                    editor:{
							                    type:'combobox',
							                    options:{
								                    valueField:'fieldName',
								                    textField:'fieldName',
								                    required:true
							                    }
						                    }">Column</th>
				                    <th data-options="field:'order',width:100,
						                    formatter:function(value,row){
							                    return row.order;
						                    },
						                    editor:{
							                    type:'combobox',
							                    options:{
								                    valueField:'order',
								                    textField:'order',
								                    data:[{ 'order': 'asc' }, { 'order': 'desc' }],
								                    required:true
							                    }
						                    }">Order</th>
			                    </tr>
		                    </thead>
	                    </table>

	                    <div id="tbSort" style="height:auto">
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="appendSort()">Append</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeitSort()">Remove</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="acceptSort()">Accept</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="rejectSort()">Reject</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" onclick="getChangesSort()">GetChanges</a>
	                    </div>

                </div>
                    <input type="text" class="sort"/>
                    <label>filter:</label>

                    <div style="display:inherit;float:inherit;">

                        <table id="filterBuilder" class="easyui-datagrid" title="Create Filter Parameters" style="width:400px;height:auto"
			                    data-options="
				                    iconCls: 'icon-edit',
				                    singleSelect: true,
				                    toolbar: '#tbFilter',
				                    method: 'get',
				                    onClickRow: onClickRow
			                    ">
		                    <thead>
			                    <tr>
				                    <th data-options="field:'fieldName',width:100,
						                    formatter:function(value,row){
							                    return row.fieldName;
						                    },
						                    editor:{
							                    type:'combobox',
							                    options:{
								                    valueField:'fieldName',
								                    textField:'fieldName',
								                    required:true
							                    }
						                    }">Column</th>
				                    <th data-options="field:'operator',width:100,
						                    formatter:function(value,row){
							                    return row.operator;
						                    },
						                    editor:{
							                    type:'combobox',
							                    options:{
								                    valueField:'operator',
								                    textField:'operator',
								                    data:[{ 'operator': 'equals' }, { 'operator': 'notEquals' }, { 'operator': 'greaterThan' }, { 'operator': 'greaterThanOrEqualsTo' }, { 'operator': 'lessThan' }, { 'operator': 'lessThanOrEqualsTo' }, { 'operator': 'empty' }, { 'operator': 'notEmpty' }, { 'operator': 'startsWith' }, { 'operator': 'endsWith' }, { 'operator': 'contains' }, { 'operator': 'notContains' },{ 'operator': 'in' }],
								                    required:true
							                    }
						                    }">Operator</th>
				                    <th data-options="field:'value',width:150,editor:'text'">Value</th>
			                    </tr>
		                    </thead>
	                    </table>

	                    <div id="tbFilter" style="height:auto">
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add',plain:true" onclick="append()">Append</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit()">Remove</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="accept()">Accept</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="reject()">Reject</a>
		                    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-search',plain:true" onclick="getChanges()">GetChanges</a>
	                    </div>

                </div>

                    <input type="text" class="filter"/>
                    
                    <label>search:</label>
                    <input type="text" class="search"/>
                    
                    <br /><br />
                    
                    <button class="logoButton">logo</button>
                    <img class="logo"/>

                </fieldset>
                </div>

                <label>url:</label>
                <input type="text" class="url" value="/1/app/config"/>
                
                <label>data (json):</label>
                <textarea class="json json-input"></textarea>
                
                <label>verb:</label>
                <select class="verb">
                    <option value="GET">GET</option>
                    <option value="PUT">PUT</option>
                    <option value="POST">POST</option>
                    <option value="DELETE">DELETE</option>
                </select>

                
                <br />
                <br />
                <button class="load-sub-grid-fields">load sub-grid fields</button>
                <select class="sub-grid-fields"></select>
                <button class="load-sub-grid-data">load sub-grid data</button>

                <br />
                <br />
                <br />
                <button class="load-auto-complete-fields">load auto-complete fields</button>
                <select class="auto-complete-fields"></select>
                <input type="text" class="auto-complete" />
                <br />
                <br />
                <label>username:</label>
                <input type="text" class="unlock-user-username" />
                <button class="unlock-user">unlock</button>

                <br />
                <button class="clean">clean</button>
                <button class="submit">submit</button>

            </fieldset>

            <div>
                <button class="create-app">Create app</button>
                <label>name:</label>
                <input type="text" class="app-name"/>
                <label>title:</label>
                <input type="text" class="app-title" />
                <br />
                <select class="product">
                    <option value="2">SQL Server</option>
                    <option value="4">MySQL</option>
                </select>
                <label>server:</label>
                <input type="text" class="server" value=".\sqlexpress" />
                <label>database:</label>
                <input type="text" class="database" value="northwindqa55" />
                <label>username:</label>
                <input type="text" class="db-username" value="itay" />
                <label>password:</label>
                <input type="text" class="db-password" value="Back2013" />

                <button class="connect-app">connect</button>
                <br />
                <label>id:</label>
                <input type="text" class="app-id" />
                <button class="get-app">get apps</button>

            </div>
            <div>
                <button class="load-image-fields">load image fields</button>
                <select class="image-fields"></select>

                <form id="fileupload" name="fileupload" enctype="multipart/form-data" method="post">
                    <fieldset>
                        <input type="file" name="fileselect" id="fileselect" multiple />
                        <input id="uploadbutton" type="button" value="Upload" />
                    </fieldset>
                </form>

            </div>
        </div>
        <div class="api-output">
            <fieldset>
                <legend>Output</legend>
                <label class="duration-label">duration:</label>
                <label class="duration">0</label>
                <br />

                <label>status:</label>
                <input type="text" class="status" />

                <label>json output:</label>
                <!--<textarea class="json json-output"></textarea>-->
                <textarea class="json-viewer2"></textarea>
                <button class="json-viewer">json viewer</button>

                <label>location:</label>
                <input type="text" class="location" />

                <label>error:</label>
                <iframe class="json error-text"></iframe>
                
            </fieldset>
        </div>
        
    </div>
    <div class="login-container">
        <label>username:</label>
        <input class="username" type="text" autocomplete="on" value="" />
        <label>password:</label>
        <input class="password" type="password" autocomplete="on" value="" name="aaaaa"/>
        <label>appname:</label>
        <input class="appname" type="text" autocomplete="on" value="" />
        <button class="login">login</button>
     </div>

    <script>
        $(document).ready(function () {
            $('.get-app').click(function () {
                var appId = $('.app-id').val();
                if (appId) {
                    backand.admin.app.get(appId, success, error);
                }
                else {
                    var listParams = getListParams();
                    backand.admin.app.getList(listParams.withSelectOptions, listParams.pageNumber, listParams.pageSize, listParams.filter, listParams.sort, listParams.search, success, error);
                }
            });
            $('.create-app').click(function () {
                var name = $('.app-name').val();
                var title = $('.app-title').val();
                backand.admin.app.create(name, title, success, error);
            });
            $('.connect-app').click(function () {
                var appId = $('.app-id').val();
                var product = $('.product').val();
                var server = $('.server').val();
                var database = $('.database').val();
                var username = $('.db-username').val();
                var password = $('.db-password').val();
                backand.admin.app.connection.create(appId, product, server, database, username, password, success, error);
            });
        });
    </script>

    <script type="text/javascript">
        $(function () {
            var file;
            var files;

            // Set an event listener on the Choose File field.
            $('#fileselect').bind("change", function (e) {
                files = e.target.files || e.dataTransfer.files;
                // Our file var now holds the selected file
                file = files[0];
            });

            // This function is called when the user clicks on Upload to Parse. It will create the REST API request to upload this image to Parse.
            $('#uploadbutton').click(function () {
                var viewName = viewSelect.val();
                var fieldName = imageFieldsSelect.val();



                backand.api.file.upload(viewName, fieldName, files, success, error);


                return;

                var serverUrl = 'http://localhost:4109/backapi/1/file/upload/' + viewName + '/' + fieldName;
                //var serverUrl = 'http://localhost:4109/backapi/1/file2/';

                var data = new FormData();
                $.each(files, function (key, value) {
                    data.append(key, value);
                });

                $.ajax({
                    type: "POST",
                    beforeSend: function (request) {
                        //request.setRequestHeader("X-Parse-Application-Id", 'MY-APP-ID');
                        //request.setRequestHeader("X-Parse-REST-API-Key", 'MY-REST-API-ID');
                        request.setRequestHeader('Authorization', backand.security.authentication.token);
                        //request.setRequestHeader("Content-Type", file.type);
                        
                    },
                    url: serverUrl,
                    cache: false,
                    data: data,
                    processData: false,
                    contentType: false,
                    //mimeType: "multipart/form-data",
                    success: function (data) {
                        alert(JSON.stringify(data));
                    },
                    error: function (data) {
                        var obj = jQuery.parseJSON(data);
                        alert(obj.error);
                    }
                });
                
            });


        });
    </script>
</body>
</html>
